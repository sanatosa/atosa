<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora ATOSA para Contenedor de Sillas de Playa</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.9/xlsx.full.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: Arial, sans-serif;
            max-width: 100%;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        h1 {
            text-align: center;
            font-size: 24px;
        }
        .chair-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }
        .chair-item {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .chair-item img {
            max-width: 100%;
            height: 200px;
            object-fit: contain;
        }
        .chair-item h3 {
            font-size: 16px;
            margin: 10px 0;
        }
        .status-box {
            background-color: #f0f0f0;
            border: 2px solid #333;
            border-radius: 10px;
            padding: 20px;
            margin-top: 30px;
            text-align: center;
        }
        #container-status, #total-cost {
            font-size: 18px;
            font-weight: bold;
            margin: 10px 0;
        }
        #container-progress {
            width: 100%;
            height: 30px;
            background-color: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin-top: 10px;
        }
        #container-progress-bar {
            height: 100%;
            width: 0%;
            background-color: #4CAF50;
            transition: width 0.5s ease-in-out;
        }
        #advance-payment {
            font-size: 16px;
            margin-top: 20px;
            font-weight: bold;
            color: #FF5722;
        }
        input[type="number"] {
            width: 60px;
            padding: 5px;
            font-size: 16px;
        }
        .quantity-feedback {
            color: green;
            font-size: 0.9em;
            margin-top: 5px;
            display: none;
        }
        .quantity-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
        #order-summary {
            margin-top: 30px;
        }
        #order-summary h2 {
            margin-bottom: 10px;
            font-size: 20px;
        }
        .summary-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 10px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
        }
        .summary-item img {
            width: 80px;
            height: 80px;
            object-fit: contain;
            margin-right: 20px;
        }
        .summary-item h3 {
            font-size: 14px;
            margin: 5px 0;
        }
        .summary-item p {
            font-size: 14px;
            margin: 5px 0;
        }
        #download-button {
            display: none;
            margin-top: 20px;
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        #download-button:hover {
            background-color: #45a049;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            h1 {
                font-size: 20px;
            }
            .chair-grid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            }
            .chair-item h3 {
                font-size: 14px;
            }
            #container-status, #total-cost {
                font-size: 16px;
            }
            #advance-payment {
                font-size: 14px;
            }
            .summary-item {
                flex-direction: column;
            }
            .summary-item img {
                width: 100%;
                height: auto;
                margin-right: 0;
                margin-bottom: 10px;
            }
        }

        @media (max-width: 480px) {
            .chair-grid {
                grid-template-columns: 1fr;
            }
            input[type="number"] {
                width: 50px;
            }
            .quantity-container {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <h1>Calculadora ATOSA para Contenedor de Sillas de Playa</h1>
    <div class="chair-grid" id="chair-list">
        <!-- Las sillas se agregarán aquí dinámicamente -->
    </div>
    <div class="status-box">
        <div id="container-status"></div>
        <div id="container-progress">
            <div id="container-progress-bar"></div>
        </div>
        <div id="total-cost"></div>
        <div id="advance-payment"></div>
    </div>
    <div id="order-summary">
        <h2>Resumen del Pedido</h2>
        <div id="summary-list"></div>
    </div>
    <button id="download-button" onclick="downloadExcel()">Descargar Pedido</button>

    <script>
        const products = [
    { id: 1, name: "G. SILLA DE ALUMINIO 87X51X23 CM TEXTELINE 2X1 MARINERO", price: 21.08, image: "silla1.jpg", volume: 6.003380000000001 },
    { id: 2, name: "G. SILLA DE ALUMINIO 108X47X30 CM TEXTELINE 2X1 MARINERO  CINTA PARA HOMBRO", price: 24.14, image: "silla2.jpg", volume: 7.41594 },
    { id: 3, name: "G. SILLA DE ALUMINIO FIJA 87X47X37 CM TEXTELINE 2X1 MARINERO", price: 17.49, image: "silla3.jpg", volume: 8.12222 },
    { id: 4, name: "G. SILLA DE ALUMINIO ALTA 106X47X45 CM TEXTELINE 2X1 MARINERO  CINTA PARA HOMBRO", price: 23.64, image: "silla4.jpg", volume: 7.41594 },
    { id: 5, name: "G. SILLA DE ALUMINIO 87X51X23 CM TEXTELINE 2X1 EST. MARINOS AZUL", price: 25.94, image: "silla5.jpg", volume: 6.003380000000001 },
    { id: 6, name: "G. SILLA DE ALUMINIO 108X47X30 CM TEXTELINE 2X1 EST. MARINOS AZUL CINTA PARA HOMBRO", price: 24.78, image: "silla6.jpg", volume: 7.41594 },
    { id: 7, name: "G. SILLA DE ALUMINIO 87X47X37 CM TEXTELINE 2X1 EST. MARINOS AZUL", price: 18.14, image: "silla7.jpg", volume: 8.12222 },
    { id: 8, name: "G. SILLA DE ALUMINIO ALTA 106X47X45 CM TEXTELINE 2X1 EST. MARINOS AZUL CINTA PARA HOMBRO", price: 23.79, image: "silla8.jpg", volume: 7.41594 },
    { id: 9, name: "G. SILLA DE ALUMINIO 87X51X23 CM TEXTELINE 2X1 EST. MARINOS ROJO", price: 21.72, image: "silla9.jpg", volume: 6.003380000000001 },
    { id: 10, name: "G. SILLA DE ALUMINIO 108X47X30 CM TEXTELINE 2X1 EST. MARINOS ROJO CINTA PARA HOMBRO", price: 24.78, image: "silla10.jpg", volume: 7.41594 },
    { id: 11, name: "G. SILLA DE ALUMINIO FIJA 87X47X37 CM TEXTELINE 2X1 EST. MARINOS ROJO", price: 18.14, image: "silla11.jpg", volume: 8.12222 },
    { id: 12, name: "G. SILLA DE ALUMINIO ALTA 106X47X45 CM TEXTELINE 2X1 EST. MARINOS ROJO CINTA PARA HOMBRO", price: 24.28, image: "silla12.jpg", volume: 7.41594 },
    { id: 13, name: "G. SILLA DE ALUMINIO 87X51X23 CM TEXTELINE 2X1 AZUL", price: 21.41, image: "silla13.jpg", volume: 6.003380000000001 },
    { id: 14, name: "G. SILLA DE ALUMINIO 87X51X23 CM TEXTELINE 2X1 RAYAS VERDE", price: 21.08, image: "silla14.jpg", volume: 6.003380000000001 },
    { id: 15, name: "G. SILLA DE ALUMINIO 87X51X23 CM TEXTELINE 2X1 AZUL", price: 21.08, image: "silla15.jpg", volume: 6.003380000000001 },
    { id: 16, name: "G. SILLA DE ALUMINIO 108X47X30 CM TEXTELINE 2X1 AZUL CINTA PARA HOMBRO", price: 24.46, image: "silla16.jpg", volume: 7.41594 },
    { id: 17, name: "G. SILLA DE ALUMINIO 108X47X30 CM TEXTELINE 2X1 RAYAS VERDE CINTA PARA HOMBRO", price: 24.14, image: "silla17.jpg", volume: 7.41594 },
    { id: 18, name: "G. SILLA DE ALUMINIO 108X47X30 CM TEXTELINE 2X1 RAYA AZUL CINTA PARA HOMBRO", price: 24.14, image: "silla18.jpg", volume: 7.41594 },
    { id: 19, name: "G. SILLA DE ALUMINIO 87X47X37 CM TEXTELINE 2X1 AZUL", price: 17.81, image: "silla19.jpg", volume: 8.12222 },
    { id: 20, name: "G. SILLA DE ALUMINIO 87X47X37 CM TEXTELINE 2X1 RAYAS VERDE", price: 17.49, image: "silla20.jpg", volume: 8.12222 },
    { id: 21, name: "G. SILLA DE ALUMINIO 87X47X37 CM TEXTELINE 2X1 RAYAS AZUL", price: 17.49, image: "silla21.jpg", volume: 8.12222 },
    { id: 22, name: "G. SILLA DE ALUMINIO ALTA 106X47X45 CM TEXTELINE 2X1 AZUL CINTA PARA HOMBRO", price: 23.95, image: "silla22.jpg", volume: 7.41594 },
    { id: 23, name: "G. SILLA DE ALUMINIO ALTA 106X47X45 CM TEXTELINE 2X1 RAYAS VERDE CINTA PARA HOMBRO", price: 23.64, image: "silla23.jpg", volume: 7.41594 },
    { id: 24, name: "G. SILLA DE ALUMINIO ALTA 106X47X45 CM TEXTELINE 2X1 RAYAS AZUL CINTA PARA HOMBRO", price: 23.64, image: "silla24.jpg", volume: 7.41594 }
];

        const containerVolume = 76.4; // Volumen total del contenedor en metros cúbicos

        function updateContainer() {
            let totalVolume = 0;
            let totalCost = 0;
            let anyChairSelected = false;

            chairs.forEach((chair) => {
                const quantity = parseInt(document.getElementById(`quantity-${chair.id}`).value) || 0;
                totalVolume += (chair.volume * 35.314) * quantity; // Multiplicamos por 35.314 para corregir el cubicaje
                totalCost += chair.price * quantity;
                if (quantity > 0) {
                    anyChairSelected = true;
                }
            });

            const containerStatus = document.getElementById('container-status');
            const totalCostElement = document.getElementById('total-cost');
            const advancePaymentElement = document.getElementById('advance-payment');
            const containerProgressBar = document.getElementById('container-progress-bar');
            const downloadButton = document.getElementById('download-button');

            const percentageOccupied = (totalVolume / containerVolume) * 100;
            containerStatus.textContent = `El contenedor está al ${percentageOccupied.toFixed(2)}% de su capacidad total`;
            totalCostElement.textContent = `Coste total: ${totalCost.toFixed(2)} €`;
            
            const advancePayment = totalCost * 0.20;
            advancePaymentElement.textContent = `Pago por adelantado (20%): ${advancePayment.toFixed(2)} €`;

            containerProgressBar.style.width = `${Math.min(percentageOccupied, 100)}%`;

            if (percentageOccupied > 100) {
                containerStatus.style.color = 'red';
                containerProgressBar.style.backgroundColor = 'red';
            } else if (percentageOccupied === 100) {
                containerStatus.style.color = 'green';
                containerProgressBar.style.backgroundColor = 'green';
            } else {
                containerStatus.style.color = 'black';
                containerProgressBar.style.backgroundColor = '#4CAF50';
            }

            downloadButton.style.display = anyChairSelected ? 'block' : 'none';

            updateOrderSummary();
        }

        function showQuantityFeedback(id) {
            const feedbackElement = document.getElementById(`feedback-${id}`);
            feedbackElement.style.display = 'block';
            
            let totalVolume = 0;
            chairs.forEach((chair) => {
                const quantity = parseInt(document.getElementById(`quantity-${chair.id}`).value) || 0;
                totalVolume += (chair.volume * 35.314) * quantity; // Multiplicamos por 35.314 para corregir el cubicaje
            });
            
            const percentageOccupied = (totalVolume / containerVolume) * 100;
            feedbackElement.textContent = `Cantidad actualizada. El contenedor está al ${percentageOccupied.toFixed(2)}% de su capacidad.`;
            
            if (percentageOccupied > 100) {
                feedbackElement.style.color = 'red';
                feedbackElement.textContent += " ¡Contenedor sobrepasado!";
            } else if (percentageOccupied === 100) {
                feedbackElement.style.color = 'green';
                feedbackElement.textContent += " ¡Contenedor lleno!";
            } else {
                feedbackElement.style.color = 'green';
            }
            
            setTimeout(() => {
                feedbackElement.style.display = 'none';
            }, 3000);
        }

        function initializeChairList() {
            const chairList = document.getElementById('chair-list');
            chairs.forEach((chair) => {
                const chairElement = document.createElement('div');
                chairElement.className = 'chair-item';
                chairElement.innerHTML = `
                    <img src="images/${chair.image}" alt="${chair.name}">
                    <h3>${chair.id} - ${chair.name}</h3>
                    <p>Precio: ${chair.price.toFixed(2)} €</p>
                    <div class="quantity-container">
                        <label for="quantity-${chair.id}">Cantidad:</label>
                        <input type="number" id="quantity-${chair.id}" min="0" value="0" onchange="updateContainer(); showQuantityFeedback('${chair.id}')">
                    </div>
                    <div id="feedback-${chair.id}" class="quantity-feedback"></div>
                `;
                chairList.appendChild(chairElement);
            });
        }

        function updateOrderSummary() {
            const summaryList = document.getElementById('summary-list');
            summaryList.innerHTML = '';

            chairs.forEach((chair) => {
                const quantity = parseInt(document.getElementById(`quantity-${chair.id}`).value) || 0;
                if (quantity > 0) {
                    const summaryItem = document.createElement('div');
                    summaryItem.className = 'summary-item';
                    summaryItem.innerHTML = `
                        <img src="images/${chair.image}" alt="${chair.name}">
                        <div>
                            <h3>${chair.id} - ${chair.name}</h3>
                            <p>Cantidad: ${quantity}</p>
                            <p>Precio unitario: ${chair.price.toFixed(2)} €</p>
                            <p>Subtotal: ${(chair.price * quantity).toFixed(2)} €</p>
                        </div>
                    `;
                    summaryList.appendChild(summaryItem);
                }
            });
        }

        async function downloadExcel() {
            const workbook = XLSX.utils.book_new();
            const worksheet = XLSX.utils.aoa_to_sheet([
                ['Código', 'Nombre', 'Cantidad', 'Precio Unitario', 'Subtotal', 'Imagen']
            ]);

            let row = 1;
            for (const chair of chairs) {
                const quantity = parseInt(document.getElementById(`quantity-${chair.id}`).value) || 0;
                if (quantity > 0) {
                    const subtotal = chair.price * quantity;
                    XLSX.utils.sheet_add_aoa(worksheet, [[
                        chair.id,
                        chair.name,
                        quantity,
                        chair.price.toFixed(2),
                        subtotal.toFixed(2),
                        '(Imagen)'
                    ]], { origin: -1 });

                    // Añadir imagen
                    try {
                        const imgBlob = await fetch(`images/${chair.image}`).then(r => r.blob());
                        const base64 = await new Promise((resolve) => {
                            const reader = new FileReader();
                            reader.onload = () => resolve(reader.result.split(',')[1]);
                            reader.readAsDataURL(imgBlob);
                        });

                        const imgId = workbook.addImage({
                            base64: base64,
                            extension: 'jpg',
                        });

                        worksheet['!images'] = worksheet['!images'] || [];
                        worksheet['!images'].push({
                            image: imgId,
                            range: {
                                s: { r: row, c: 5 },
                                e: { r: row + 1, c: 6 }
                            }
                        });
                    } catch (error) {
                        console.error('Error al cargar la imagen:', error);
                    }

                    row++;
                }
            }

            XLSX.utils.book_append_sheet(workbook, worksheet, 'Pedido');

            // Ajustar ancho de columnas
            const wscols = [
                {wch: 10},
                {wch: 50},
                {wch: 10},
                {wch: 15},
                {wch: 15},
                {wch: 20}
            ];
            worksheet['!cols'] = wscols;

            XLSX.writeFile(workbook, 'Pedido_Sillas_Playa.xlsx');
        }

        initializeChairList();
        updateContainer();
    </script>
</body>
</html>
